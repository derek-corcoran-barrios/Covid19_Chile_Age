---
title: "Informe 3"
author: "Derek Corcoran, Giorgia Graells, Horacio Samaniego, Pablo Marquet"
date: "20/04/2020"
output:
    bookdown::pdf_document2:
      keep_tex: true
      fig_caption: true
      toc: false
bibliography: Biblio.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, tidy = TRUE, tidy.opts = list(blank = FALSE, width.cutoff = 60))
library(formatR)
library(kableExtra)
library(scales)
library(tidyverse)
```

# Introducción 

En este documento se mostrarán simulaciones destinadas a responder 3 puntos de la minuta solicitados por el ministerio de ciencia, basado en un modelo con conectividad espacial y estrucutrado por edades [@arenas2020mathematical], la modificación del modelo se encuentra explicada en detalle en @corcoran_graells_2020

1. Cuarentena total, las personas quedan con prohibición de salir de su casa, solo con permiso especiales.

2. Cuarentenas alternantes por comunas a nivel nacional de 15 días, las personas quedan con prohibición de salir de su casa 15 días (cuarentena) y luego 15 días con cierre de colegios y comercio. Una comuna entra en cuarentena cuando los casos llegan a 4 o 5 por 10.000.

3. Cierre de colegios y comercio.

# Simulaciones

Para todas las simulaciones se usaron el las funciones descritas y disponibles en @derek_corcoran_barrios_2020_3756847, ahí también se encuentran las bases de datos con las que se realizaron estas simulaiciones

## Extensión óptima de cuarentena total. Simulación del 15 abril al 14 junio

Para obtener la extensión óptima de una cuarentena total a nivel nacional se realizaron 12 simulaciones distintas que parten el día 20 de abril. Se consideraron 3 extensiones de cuarentena nacional (7, 15 y 30 días) y 3 valores de grado de confinamiento o $\kappa_0$ distintos (0.5, 0.75 y 0.85, cada una representando cuarentenas con control leve, medio o fuerte). Para tener las condiciones iniciales del 20 de abril se modeló del 15 abril al 20 abril, manteniendo una cuarentena dinámica por comuna.


Estas simulaciones se contrastaron con una cuarentena dinámica la cual se gatilla cuando el número de infectados llega a 40/100,000 casos activos confirmados. Una vez gatillada la cuarentena, esta durará como mínimo 7 días, y al pasar los 7 días se observa la prevalencia nuevamente para determinar si la cuarentena se levanta o se renueva por otros 7 días


## Inicio óptimo de cuarentena total

Determinación de fechas de inicio considerando extensión óptima definida

Esta parte asume que en la sección anterior se determinó la extensión optima que será simulada despúes de la cuarentena dinámica. Se simularán dos semanas sin cuarentena posterior a este periodo para ver los efectos.

- 1. Desde el 15 abril cuarentena dinámica, 2. desde el 20 mayo cuarentena nacional por el número de días generado por la simulación anterior y 3. dos semanas sin cuarentena
- 1. Desde el 15 abril cuarentena dinámica, 2. desde el 1 mayo cuarentena nacional por el número de días generado por la simulación anterior y 3. dos semanas sin cuarentena
- 1. Desde el 15 abril cuarentena dinámica, 2. desde el 15 mayo cuarentena nacional por el número de días generado por la simulación anterior y 3. dos semanas sin cuarentena
- 1. Desde el 15 abril cuarentena dinámica, 2. desde el 30 mayo cuarentena nacional por el número de días generado por la simulación anterior y 3. dos semanas sin cuarentena


# Resultados

```{r}

DF <- data.frame(Inicio = c("Total 7 días", "Total 15 días", "Total 30 días"), Fecha = c(lubridate::dmy("20/04/2020")+ 7, lubridate::dmy("20/04/2020")+ 15,lubridate::dmy("20/04/2020")+ 30))

# leemos para kappa = 0.5

Results1 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_5_Total_7_Metropolitana.rds") %>% mutate(Kappa = as.character(0.5), Estrategia = "Total 7 días")

Results2 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_5_Total_15_Metropolitana.rds") %>% mutate(Kappa = as.character(0.5), Estrategia = "Total 15 días")

Results3 <-read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_5_Total_30_Metropolitana.rds") %>% mutate(Kappa = as.character(0.5), Estrategia = "Total 30 días")



# leemos para kappa = 0.75

Results4 <-read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_75_Total_7_Metropolitana.rds") %>% mutate(Kappa = as.character(0.75), Estrategia = "Total 7 días")

Results5 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_75_Total_15_Metropolitana.rds") %>% mutate(Kappa = as.character(0.75), Estrategia = "Total 15 días")

Results6 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_75_Total_30_Metropolitana.rds") %>% mutate(Kappa = as.character(0.75), Estrategia = "Total 30 días")

## Agregamos los resultados para kappa = 0.85

Results7 <-read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_85_Total_7_Metropolitana.rds") %>% mutate(Kappa = as.character(0.85), Estrategia = "Total 7 días")

Results8 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_85_Total_15_Metropolitana.rds") %>% mutate(Kappa = as.character(0.85), Estrategia = "Total 15 días")

Results9 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_85_Total_30_Metropolitana.rds") %>% mutate(Kappa = as.character(0.85), Estrategia = "Total 30 días")

## Agregamos el resultado dinámico  y mínimo 7 días de cuarentena

Results10 <- read_rds("/home/derek/Documents/Covid19_Chile_Age/Results/Metropolitana/Results_2020_04_15_K_0_5_Dinamica_7_Metropolitana.rds") %>% mutate(Kappa = as.character(0.5), Estrategia = "Dinámica 7 días")


## Unimos todo

Results <- list(Results1, Results2, Results3, Results4, Results5, Results6, Results7, Results8, Results9, Results10) %>% purrr::reduce(bind_rows)
```

## Nivel País

```{r}
Results_Pais <- Results %>% group_by(Fecha, Kappa, Estrategia) %>% summarise_if(is.numeric, sum) %>% dplyr::select("Fecha", "Kappa", "Estrategia", "Poblacion", "Infectados", 
"Suceptibles", "Expuestos", "Asintomaticos", "UCI", "Muerto", 
"Recuperados", "Time") %>% mutate(Infectados_Acumulados = Infectados + UCI + Muerto + Recuperados) %>% ungroup()
```


```{r}
ggplot(Results_Pais, aes(x = Fecha, y = Infectados)) + geom_line(aes(color = Estrategia)) + facet_grid(rows = vars(Kappa)) + theme_bw() + scale_y_continuous(labels = comma)  + geom_vline(xintercept = lubridate::dmy("20/04/2020"), lty = 2) + annotate("text", x = lubridate::dmy("19/04/2020"), y = 1000000, label = "Inicio cuarentena", angle = 90) + geom_vline(data = DF, aes (xintercept = Fecha, color = Inicio), lty = 2, show.legend = F) 
```

```{r}
ggplot(Results_Pais, aes(x = Fecha, y = UCI)) + geom_line(aes(color = Estrategia)) + facet_grid(rows = vars(Kappa)) + theme_bw() + scale_y_continuous(labels = comma) + geom_vline(xintercept = lubridate::dmy("20/04/2020"), lty = 2) + annotate("text", x = lubridate::dmy("19/04/2020"), y = 150000, label = "Inicio cuarentena", angle = 90) + geom_vline(data = DF, aes (xintercept = Fecha, color = Inicio), lty = 2, show.legend = F) 
```

## Región Metropolitana

```{r}
Results_RM_Total <- Results %>% dplyr::filter(Comuna != "pais") %>% group_by(Fecha, Kappa, Estrategia) %>% summarise_if(is.numeric, sum) %>% dplyr::select("Fecha", "Kappa", "Estrategia", "Poblacion", "Infectados", 
"Suceptibles", "Expuestos", "Asintomaticos", "UCI", "Muerto", 
"Recuperados", "Time") %>% mutate(Infectados_Acumulados = Infectados + UCI + Muerto + Recuperados) %>% ungroup()
```


```{r}
ggplot(Results_RM_Total, aes(x = Fecha, y = Infectados)) + geom_line(aes(color = Estrategia)) + facet_grid(rows = vars(Kappa)) + theme_bw() + scale_y_continuous(labels = comma) + geom_vline(xintercept = lubridate::dmy("20/04/2020"), lty = 2) + annotate("text", x = lubridate::dmy("19/04/2020"), y = 500000, label = "Inicio cuarentena", angle = 90) + geom_vline(data = DF, aes (xintercept = Fecha, color = Inicio), lty = 2, show.legend = F) 
```

```{r}
ggplot(Results_RM_Total, aes(x = Fecha, y = UCI)) + geom_line(aes(color = Estrategia)) + facet_grid(rows = vars(Kappa)) + theme_bw() + scale_y_continuous(labels = comma)
```

## Nivel Comunal Región Metropolitana

```{r}
Results_Comunal <- Results %>% dplyr::filter(Comuna != "pais") %>% group_by(Fecha, Kappa, Estrategia, Comuna) %>% summarise_if(is.numeric, sum) %>% dplyr::select("Fecha", "Comuna", "Kappa", "Estrategia", "Poblacion", "Infectados", 
"Suceptibles", "Expuestos", "Asintomaticos", "UCI", "Muerto", 
"Recuperados", "Time") %>% mutate(Infectados_Acumulados = Infectados + UCI + Muerto + Recuperados) %>% ungroup()
```


```{r}
Eficiencia <- Results_Comunal %>% dplyr::filter(Kappa == 0.5) %>% group_by(Estrategia, Comuna) %>% dplyr::filter(UCI == max(UCI)) %>% dplyr::select(Estrategia, Comuna, UCI, Fecha, Poblacion) %>% ungroup() %>% group_by(Comuna) %>% dplyr::filter(UCI == max(UCI) | UCI == min(UCI)) %>% ungroup() %>% dplyr::select(-Fecha)

Eficiencia_Max <- Eficiencia %>% group_by(Comuna) %>% dplyr::select(-Estrategia) %>% dplyr::filter(UCI == max(UCI)) %>% rename(UCI_max = UCI) %>% ungroup()

Eficiencia_Min <- Eficiencia %>% group_by(Comuna) %>% dplyr::select(-Estrategia) %>% dplyr::filter(UCI == min(UCI)) %>% rename(UCI_min = UCI) %>% ungroup()

Eficiencia <- suppressMessages(full_join(Eficiencia_Max, Eficiencia_Min))
Eficiencia<- Eficiencia %>% mutate(Eficiencia = ((UCI_max - UCI_min)/Poblacion)*100000) %>% arrange(desc(Eficiencia))

Extremos <- Eficiencia[c(1:8,45:52),] %>% pull(Comuna)
```



```{r}
Graph_Comunal <- Results_Comunal %>% dplyr::filter(Comuna %in% Extremos, Kappa == 0.5)

ggplot(Graph_Comunal, aes(x = Fecha, y = UCI)) + geom_line(aes(color = Estrategia)) + facet_wrap(~Comuna, scales = "free_y") + theme_bw() + scale_y_continuous(labels = comma)
```


